load(cj_function)$
load(hj_fortran2)$

optimprefix: tt$

f: openw("sdf.f90")$

block(
  [X, C, N, r1, r2],
  X:  genmatrix(X, 3, 1),
  C:  genmatrix(C, 3, 1),
  N:  genmatrix(N, 3, 1),
  r1: genmatrix(r1, 1, 1),
  r2: genmatrix(r2, 1, 1),

  torus_sdf(X, C, N, r1, r2) := block(
    [tmp],
    tmp: X-C-DOT(X-C, N)*N,
    matrix([ NORM(X-C-(r2[1,1]+r1[1,1])/2*tmp/NORM(tmp)) - (r2[1,1]-r1[1,1])/2 ])
  ),
  with_stdout(f, val_jac_hes_to_f90(torus_sdf, [X, C, N, r1, r2])),

  cylinder_sdf(X, C, N, r1) := block(
    [tmp],
    tmp: X-C-DOT(X-C, N)*N,
    matrix([ NORM(tmp)-r1[1,1] ])
  ),
  with_stdout(f, val_jac_hes_to_f90(cylinder_sdf, [X, C, N, r1])),

  return()
)$

close(f)$